generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
}

enum PaymentMethod {
  intasend
  stripe
  paypal
  cod
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum ActionType {
  CREATE_ACCOUNT
  LOGIN
  LOGOUT
  PURCHASE
}

enum CouponType {
  percent
  fixed
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

model User {
  id                   String      @id @default(uuid())
  name                 String
  email                String      @unique
  password             String
  role                 UserRole    @default(user)
  isSeller             Boolean     @default(false)
  sellerApproved       Boolean     @default(false)
  sellerApprovalRequestedAt DateTime?
  sellerApprovedAt     DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  reviews              Review[]
  orders               Order[]
  wishlist             Wishlist[]
  actionLogs           ActionLog[]
  supportTickets       SupportTicket[]
  cart                 Cart?
  savedAddresses       Json[]
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
}

model Product {
  id           String      @id @default(uuid())
  name         String
  slug         String      @unique
  description  String
  category     String
  brand        String      @default("Generic")
  price        Float
  countInStock Int         @default(0)
  images       String[]
  rating       Float       @default(0)
  numReviews   Int         @default(0)
  featured     Boolean     @default(false)
  reviews      Review[]
  wishlist     Wishlist[]
  orderItems   OrderItem[]
  cartItems    CartItem[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  productId String
  rating    Int
  comment   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
}

model Wishlist {
  userId    String
  productId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
}

model Order {
  id              String        @id @default(uuid())
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  isGuest         Boolean       @default(false)
  guestEmail      String?
  guestFullName   String?
  guestPhone      String?
  orderItems      OrderItem[]
  shippingAddress Json
  paymentMethod   PaymentMethod @default(intasend)
  paymentResult   Json?
  itemsPrice      Float         @default(0)
  taxPrice        Float         @default(0)
  shippingPrice   Float         @default(0)
  totalPrice      Float         @default(0)
  isPaid          Boolean       @default(false)
  paidAt          DateTime?
  isDelivered     Boolean       @default(false)
  deliveredAt     DateTime?
  status          OrderStatus   @default(pending)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model OrderItem {
  id                 String  @id @default(uuid())
  orderId            String
  productId          String
  name               String
  image              String
  price              Float
  quantity           Int
  sellerName         String  @default("Unknown Seller")
  grossAmount        Float   @default(0)
  platformCommission Float   @default(0)
  sellerEarning      Float   @default(0)
  order              Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

model ActionLog {
  id        String     @id @default(uuid())
  action    ActionType
  details   String?
  ipAddress String?
  userAgent String?
  userId    String?
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime   @default(now())

  @@index([createdAt])
  @@index([action])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  productId String
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([cartId, productId])
}

model Coupon {
  id          String     @id @default(uuid())
  code        String     @unique
  type        CouponType
  value       Float
  minSubtotal Float      @default(0)
  expiresAt   DateTime
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model FlashBanner {
  id        String   @id @default(uuid())
  title     String
  subtitle  String
  cta       String
  color     String
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupportTicket {
  id        String       @id @default(uuid())
  userId    String?
  name      String
  email     String
  subject   String
  message   String
  orderId   String?
  status    TicketStatus @default(open)
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}
